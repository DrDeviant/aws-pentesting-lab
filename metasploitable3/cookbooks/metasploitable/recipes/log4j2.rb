#
# Cookbook:: metasploitable
# Recipe:: Log4j2 vulnerability CVE-2021-44228
#
# Copyright:: 2021, juanjo sanz
# ref:https://vulndev.io/2021/12/11/lab-exploiting-log4shell-cve-2021-44228/

include_recipe 'iptables::default'

recipe_port = 8888

iptables_rule '1_readme_app' do
  lines "-A INPUT -p tcp --dport #{recipe_port} -j ACCEPT"
end


git "/opt/log4j2" do
  repository "https://github.com/mbechler/marshalsec.git"
  action :checkout
end

bash "Install dependencies" do
  code <<-EOH
    cd /opt/log4j2
    mvn package -DskipTests
    java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://localhost:#{recipe_port}/#RCE"
  EOH
end

template '/opt/log4j2/start.sh' do
  variables( log4j2_port: recipe_port )
  source 'log4j2_app/start.sh.erb'
end

cookbook_file '/etc/init/log4j2_app.conf' do
  source 'log4j2_app/log4j2_app.conf'
  mode '0644'
end

bash 'set permissions' do
  cwd '/opt/log4j2_app'
  code <<-EOH
    chown -R chewbacca:users .
    git ls-files | xargs chmod 0644
    git ls-files | xargs -n 1 dirname | uniq | xargs chmod 755
    chmod 0755 ./start.sh
  EOH
end

service 'log4j2_app' do
  supports restart: false, start: true, reload: false, status: false
  action [:enable, :start]
end
